
--- START FILE: .gitignore ---

# ---------------------------------
# Node.js Dependencies
# ---------------------------------
/node_modules

# ---------------------------------
# Secrets and Environment Variables
# ---------------------------------
# NEVER commit your API key or secrets
.env

# ---------------------------------
# Logs and Debugging
# ---------------------------------
npm-debug.log*
.DS_Store
package-lock.json


--- END FILE: .gitignore ---

--- START FILE: package.json ---

{
  "name": "numerology-site",
  "version": "1.0.0",
  "main": "index.js",
  "type": "module",  
  "scripts": {
    "start": "node server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "@google/genai": "^1.34.0",
    "dotenv": "^17.2.3",
    "express": "^5.2.1"
  }
}

--- END FILE: package.json ---

--- START FILE: server.js ---

// server.js
import express from 'express';
import dotenv from 'dotenv';
import { GoogleGenAI } from '@google/genai';
import path from 'path';
import { fileURLToPath } from 'url';

// --- Setup ---
dotenv.config();
const app = express();
const PORT = process.env.PORT || 3000;

// Initialize GoogleGenAI client and define models
const ai = new GoogleGenAI({}); 
const numerologyModel = "gemini-2.5-flash-preview-09-2025"; 
const chatModel = "gemini-2.5-flash-preview-09-2025"; 

// Setup paths for serving
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PUBLIC_PATH = path.join(__dirname, 'public'); 

// Middleware
app.use(express.json());

// 1. Static File Serving
app.use(express.static(PUBLIC_PATH)); 

// 2. Explicit Root Route
app.get('/', (req, res) => {
    res.sendFile(path.join(PUBLIC_PATH, 'index.html')); 
});

// --- Numerology Helper Functions and Matrices ---

// Helper function to reduce a number to a single digit (1-9)
function calculateSingleDigit(num) {
    if (typeof num !== 'number') num = parseInt(num, 10);
    if (isNaN(num)) return 0;
    
    let s = String(num);
    
    while (s.length > 1) { 
        let sum = 0;
        for (let i = 0; i < s.length; i++) {
            sum += parseInt(s[i], 10);
        }
        s = String(sum);
    }
    return parseInt(s, 10);
}

// Helper function to calculate Birth Number (Day only)
function calculateBirthNumber(dob) {
    // Extract day component (DD)
    const date = new Date(dob);
    // Ensure we handle date parsing robustly, using UTC methods
    const day = date.getUTCDate();
    return calculateSingleDigit(day);
}

// Helper function to calculate Life Path Number (M+D+Y)
function calculateLifePathNumber(dob) {
    const date = new Date(dob);
    // Note: JS Date month is 0-indexed, so add 1
    const month = date.getUTCMonth() + 1;
    const day = date.getUTCDate();
    const year = date.getUTCFullYear();
    
    // Sum all digits of M, D, and Y components and reduce
    const allDigits = String(month) + String(day) + String(year);
    let sum = 0;
    for (const digit of allDigits) {
        sum += parseInt(digit, 10);
    }
    
    // Note: The reduction maintains consistency with the 1-9 planetary mapping.
    return calculateSingleDigit(sum);
}

// --- NEW: Name Calculation (Destiny Number) ---
const NAME_MAPPING = {
    A: 1, I: 1, J: 1, Q: 1, Y: 1,
    B: 2, K: 2, R: 2,
    C: 3, G: 3, L: 3, S: 3,
    D: 4, M: 4, T: 4,
    E: 5, H: 5, N: 5, X: 5,
    U: 6, V: 6, W: 6,
    O: 7, Z: 7,
    F: 8, P: 8,
};

function calculateDestinyNumber(name) {
    if (!name) return 0;
    // Normalize name: uppercase and remove non-alphabetic characters
    name = name.toUpperCase().replace(/[^A-Z]/g, ''); 
    let sum = 0;
    for (const letter of name) {
        sum += NAME_MAPPING[letter] || 0;
    }
    // The Destiny Number is often reduced fully
    return calculateSingleDigit(sum);
}


// --- Planetary Mapping Matrix (Vedic Grahas) ---
const PLANETARY_MAPPING = {
    1: { planet: "Sun (Surya â˜‰)", day: "Sunday", influence: "Authority, Soul, Leadership, Vitality, Ego." },
    2: { planet: "Moon (Chandra â˜½)", day: "Monday", influence: "Mind, Emotions, Intuition, Fluctuation, Nurturing." },
    3: { planet: "Jupiter (Guru â™ƒ)", day: "Thursday", influence: "Wisdom, Growth, Guidance, Fortune, Expansion." },
    4: { planet: "Rahu (â˜Š - North Node)", day: "Saturday/Wednesday (often mixed)", influence: "Innovation, Rebellion, Illusions, Unexpected Change, Material Obsession." },
    5: { planet: "Mercury (Budh â˜¿)", day: "Wednesday", influence: "Communication, Intellect, Versatility, Business Acumen, Youthfulness." },
    6: { planet: "Venus (Shukra â™€)", day: "Friday", influence: "Love, Beauty, Luxury, Comforts, Relationships, Arts." },
    7: { planet: "Ketu (â˜‹ - South Node)", day: "Thursday/Tuesday (often mixed)", influence: "Spirituality, Detachment, Research, Introspection, Past Life Karma." },
    8: { planet: "Saturn (Shani â™„)", day: "Saturday", influence: "Karma, Discipline, Delays, Structure, Responsibility, Hard Work." },
    9: { planet: "Mars (Mangal â™‚)", day: "Tuesday", influence: "Energy, Courage, Action, Initiative, Conflict, Drive." }
};

// --- NEW: Detailed Personality Profile Matrix (Derived from Advice Text) ---
const NUMEROLOGY_PROFILES = {
    1: { core: "Leader, Independent, Confident", focus: "Authority, originality, achievement.", challenge: "Egoistic, impatient, dominating.", group: "Action & Power" },
    2: { core: "Diplomatic, Gentle, Cooperative", focus: "Harmony, relationships, balance.", challenge: "Over-sensitive, indecisive, dependent.", group: "Emotional & Relationship" },
    3: { core: "Creative, Expressive, Charming", focus: "Communication, ideas, art, fun.", challenge: "Scattered, impulsive, avoids discipline.", group: "Creative & Expressive" },
    4: { core: "Practical, Disciplined, Reliable", focus: "Stability, systems, order.", challenge: "Rigid, stubborn, overly cautious.", group: "Action & Power" },
    5: { core: "Adventurous, Energetic, Freedom-loving", focus: "Travel, change, excitement.", challenge: "Restless, inconsistent, impulsive.", group: "Creative & Expressive" },
    6: { core: "Caring, Nurturing, Responsible", focus: "Beauty, harmony, service, family.", challenge: "Over-giving, controlling, perfectionist.", group: "Emotional & Relationship" },
    7: { core: "Intellectual, Spiritual, Introspective", focus: "Solitude, research, deeper truths.", challenge: "Detached, skeptical, emotionally distant.", group: "Spiritual & Intellectual" },
    8: { core: "Ambitious, Disciplined, Strategic", focus: "Success, money, structure, power.", challenge: "Controlling, emotionally reserved, rigid.", group: "Action & Power" },
    9: { core: "Compassionate, Humanitarian, Wise", focus: "Helping others, big-picture thinking.", challenge: "Over-emotional, self-sacrificing, unrealistic.", group: "Emotional & Relationship" }
};

// Matrices: M[BirthNo - 1][LifePathNo - 1] 
const ARCHETYPE_MATRIX = [
    // Mission 1        2            3            4            5             6             7             8             9
    ["Pure Pioneer", "Diplomatic Leader", "Expressive Leader", "Structured Leader", "Versatile Leader", "Responsible Leader", "Intuitive Leader", "Powerful Leader", "Serving Leader"], 
    ["Leading Diplomat", "Pure Peacemaker", "Creative Partner", "Stable Partner", "Flexible Diplomat", "Nurturing Partner", "Analytical Partner", "Balanced Executive", "Supportive Humanitarian"], 
    ["Original Artist", "Harmonious Creator", "Pure Expression", "Structured Artist", "Free-Form Creator", "Nurturing Creator", "Inspirational Analyst", "Charming Executive", "Expressive Humanitarian"], 
    ["Leading Builder", "Cooperative Builder", "Social Organizer", "Pure Structure", "Rigid Freedom", "Nurturing Organizer", "Scientific Builder", "Executive Organizer", "Serving Builder"], 
    ["Dynamic Individual", "Social Adventurer", "Artistic Communicator", "Controlled Change", "Pure Seeker", "Restless Nurturer", "Intellectual Traveler", "Powerful Pioneer", "Global Adventurer"], 
    ["Authoritative Carer", "Pure Nurturer", "Joyful Healer", "Structured Provider", "Versatile Teacher", "Pure Service", "Intuitive Helper", "Executive Caretaker", "Serving Nurturer"], 
    ["Pioneering Seeker", "Harmonious Analyst", "Inspirational Thinker", "Technical Analyst", "Adventurous Seeker", "Responsible Philosopher", "Pure Wisdom", "Strategic Thinker", "Compassionate Seeker"], 
    ["Leading Executive", "Diplomatic Manager", "Charismatic Power", "Structured Authority", "Risk-Taking Leader", "Responsible Manager", "Analytical Executive", "Pure Power", "Serving Executive"], 
    ["Pioneering Altruist", "Peacekeeping Server", "Expressive Altruist", "Structured Compassion", "Versatile Server", "Pure Compassion", "Intuitive Humanitarian", "Powerful Philanthropist", "Pure Service"] 
];

const CAREER_MATRIX = [
    // Mission 1        2            3            4            5             6             7             8             9
    ["Solo Entrepreneur", "Team Lead / PM", "Advertising Executive", "Independent Architect", "Sales Pioneer", "Community Organizer", "Intellectual Property Lawyer", "Corporate CEO", "Global Change Agent"], 
    ["Diplomatic Negotiator", "Couples Counselor", "Event Planner / Host", "Collaborative Engineer", "HR Mediator", "Group Home Director", "Research Partner", "Financial Consultant", "International Aid Worker"], 
    ["Film Director", "Public Relations", "Motivational Speaker", "Graphic Designer", "Travel Writer / Blogger", "Teacher of the Arts", "Literary Critic / Editor", "Marketing Executive", "Documentary Filmmaker"], 
    ["General Contractor", "Office Administrator", "Technical Trainer", "Civil Engineer", "Operations Consultant", "Pediatric Nurse", "Technical Specialist", "Financial Controller", "Infrastructure Planner"], 
    ["Expedition Leader", "Foreign Service", "Stand-up Comedian", "Data Analyst", "Investigative Reporter", "Travel Agent", "Scientific Researcher", "Corporate Trainer", "Global Humanitarian"], 
    ["Primary Care Physician", "Marriage Counselor", "Music Therapist", "Home Builder", "Consumer Advocate", "Social Worker / Caretaker", "Veterinarian", "Hospital Administrator", "Nonprofit Director"], 
    ["Academic Dean", "Research Facilitator", "Spiritual Teacher", "Cryptographer", "Philosophical Lecturer", "Librarian / Archivist", "Theoretical Scientist", "Investment Strategist", "Ethicist / Philosopher"], 
    ["Business Owner", "Political Leader", "Corporate Lawyer", "Real Estate Developer", "Urban Planner", "Executive Recruiter", "M&A Analyst", "Stock Broker / Tycoon", "Political Lobbyist"], 
    ["Pioneering Altruist", "Peacekeeping Server", "Expressive Altruist", "Structured Compassion", "Versatile Server", "Pure Compassion", "Intuitive Humanitarian", "Powerful Philanthropist", "Global Activist / UN Worker"] 
];


// --- API Endpoints ---

// 1. Numerology Calculation Endpoint (Structured Profile Output)
app.post('/api/numerology-profile', async (req, res) => {
    const { name, dob } = req.body;

    if (!name || !dob) {
        return res.status(400).send({ error: "Name and Date of Birth are required." });
    }

    // --- START: Calculation and Data Lookup (Moved outside try/catch) ---

    // Calculate necessary numbers (1-9)
    const birthNo = calculateBirthNumber(dob);
    const lifePathNo = calculateLifePathNumber(dob);
    const destinyNo = calculateDestinyNumber(name);

    // Lookup Archetype and Career based on matrices
    const archetype = ARCHETYPE_MATRIX[birthNo - 1][lifePathNo - 1];
    const career = CAREER_MATRIX[birthNo - 1][lifePathNo - 1];
    
    // Lookup Planetary Data
    const birthPlanet = PLANETARY_MAPPING[birthNo];
    const missionPlanet = PLANETARY_MAPPING[lifePathNo];
    const destinyPlanet = PLANETARY_MAPPING[destinyNo]; 
    
    // Lookup Detailed Profiles 
    const birthProfile = NUMEROLOGY_PROFILES[birthNo];
    const missionProfile = NUMEROLOGY_PROFILES[lifePathNo];
    const destinyProfile = NUMEROLOGY_PROFILES[destinyNo];

    // Basic Validation: Ensure numbers are mapped (i.e., not 0 due to bad input parsing)
    if (!birthPlanet || !missionPlanet || !destinyPlanet || !birthProfile || !missionProfile || !destinyProfile) {
         return res.status(400).send({ error: "Invalid date or name format. Could not map numerology numbers (expect 1-9)." });
    }

    // --- END: Calculation and Data Lookup ---

    try {
        const numerologyPrompt = `
            You are a highly skilled, engaging, and detailed numerologist and Vedic astrologer (Jyotish). Your response MUST be a single, clean JSON object that strictly adheres to the provided schema. Do not include any text outside the JSON object. Use rich Markdown syntax (lists, bolding, headings) within the string fields for optimal rendering.

            **Core Data:**
            *   Full Name: ${name}
            *   Date of Birth: ${dob}
            *   Personality/Birth Number: ${birthNo} (Governed by ${birthPlanet.planet})
            *   Mission/Life Path Number: ${lifePathNo} (Governed by ${missionPlanet.planet})
            *   Destiny Number (Name Vibe): ${destinyNo} (Governed by ${destinyPlanet.planet})
            *   Combined Archetype: ${archetype}
            *   Best Fit Career Vocation: ${career}
            *   Planetary Day of Strength: ${birthPlanet.day}

            // --- NEW CONTEXT INJECTION ---
            **Detailed Personality Coordinates (INSTRUCTIVE DATA):**
            *   Birth Number (${birthNo}) Core: ${birthProfile.core} (Focus: ${birthProfile.focus})
            *   Life Path Number (${lifePathNo}) Core: ${missionProfile.core} (Focus: ${missionProfile.focus})
            *   Numerical Group Synergy (Birth/Mission): ${birthProfile.group} meets ${missionProfile.group}

            **Instructions for JSON Content Generation:**
            1.  **title:** Must be the Archetype as the main title (e.g., "The ${archetype} Destiny Profile").
            2.  **lifePathSummary:** Explain the meaning of the combined Archetype (${archetype}). **CRITICAL:** Analyze the synergy or friction between the Birth Number's group (${birthProfile.group}) and the Life Path Number's group (${missionProfile.group}). Detail how the Birth Number's core drive (${birthProfile.core}) aids or frustrates the Life Path's mission (${missionProfile.core}).
            3.  **vedicFusion:** Provide a deep, detailed analysis (Jyotish Focus) of how the governing planetsâ€”${birthPlanet.planet} (Personality) and ${missionPlanet.planet} (Mission)â€”flavor the user's life according to Vedic wisdom. Discuss core karmic themes and disposition (Prakriti) imparted by these two Grahas.
            4.  **strengths:** Identify three key positive personality traits and inherent talents resulting from this specific fusion. Ensure these align with the positive core attributes listed in the coordinates section above. Use a markdown list.
            5.  **challenges:** Identify three key potential struggles, pitfalls, or growth areas. **CRITICAL:** Ensure the common "weak side" of the Birth Number (e.g., "${birthProfile.challenge}") and Life Path Number (e.g., "${missionProfile.challenge}") are directly addressed as potential struggles or internal conflicts. Use a markdown list.
            6.  **remedies:** Provide three specific, practical Vedic remedial suggestions (Upayes) based on the combined planetary influences (e.g., mantra recommendations, specific days/colors to utilize, offerings, or activities). Mention utilizing their Planetary Day of Strength (${birthPlanet.day}). Use a markdown list.
            7.  **destinyExplanation:** Provide a detailed explanation of the Destiny Number (${destinyNo}) and its planetary ruler. **CRITICAL:** Use the Destiny Profile's core traits (${destinyProfile.core}) to describe the ultimate life expression and impact on the world.
        `;

        // Define the JSON structure for the Gemini API call
        const numerologySchema = {
            type: "object",
            properties: {
                title: { type: "string" },
                lifePathSummary: { type: "string" },
                vedicFusion: { type: "string" },
                strengths: { type: "string" },
                challenges: { type: "string" },
                remedies: { type: "string" },
                destinyExplanation: { type: "string" }
            },
            required: ["title", "lifePathSummary", "vedicFusion", "strengths", "challenges", "remedies", "destinyExplanation"]
        };


        const aiResponse = await ai.models.generateContent({
            model: numerologyModel,
            contents: numerologyPrompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: numerologySchema
            }
        });
        
        // Parse the AI's JSON text output
        const resultJson = JSON.parse(aiResponse.text);

        // Structure the response data for the UI and Destiny Vault
        res.json({ 
            result: resultJson, // Structured JSON
            metadata: {
                name,
                dob,
                birthNo,
                lifePathNo,
                destinyNo, 
                archetype,
                career,
                dateGenerated: new Date().toISOString(),
                birthPlanet: birthPlanet.planet,
                missionPlanet: missionPlanet.planet,
                destinyPlanet: destinyPlanet.planet
            }
        });

    } catch (error) {
        console.error("Gemini Numerology Error:", error);
        if (error.response && error.response.text) {
             console.error("Raw AI Response:", error.response.text.substring(0, 500));
        }
        res.status(500).send({ error: "Failed to generate comprehensive profile from AI. Check API key and model setup." });
    }
});


// 2. Word/Number Profile Endpoint (Arbitrary Text Analysis)
app.post('/api/word-profile', async (req, res) => {
    const { input } = req.body; 

    if (!input) {
        return res.status(400).send({ error: "Input text or number is required." });
    }

    const wordPrompt = `
        You are an expert numerological analyst focusing on the energy and vibrational frequency of words, names, or concepts.
        Analyze the following input: "${input}".

        **Instructions:**
        1.  **Title:** Use the input as the title (e.g., "# Analysis of: ${input}").
        2.  **Calculation:** Calculate the final single-digit numerological value for the input string (using standard methods). Show the calculation steps clearly in the response.
        3.  **Core Vibration:** Explain the meaning of the resulting single digit in the context of the input (e.g., purpose, challenge, energy).
        4.  **Vibrational Profile:** Describe the general 'vibe' or profile of the input, including its inherent strengths and potential challenges.
        5.  **Actionable Insight:** Provide an actionable insight or prediction based on this vibrational analysis.
        6.  The entire response MUST be formatted using clear, professional Markdown.
    `;

    try {
        const response = await ai.models.generateContent({
            model: numerologyModel,
            contents: wordPrompt,
        });
        
        res.json({ result: response.text });

    } catch (error) {
        console.error("Gemini Word Profile Error:", error);
        res.status(500).send({ error: "Failed to generate word/number profile from AI." });
    }
});


// 3. Floating Chatbot Endpoint (Unchanged logic)
app.post('/api/chat', async (req, res) => {
    const { history, currentMessage } = req.body;

    if (!currentMessage) {
        return res.status(400).send({ error: "Message is required." });
    }
    
    // Convert client history format to Gemini's format
    const contents = history.map(msg => ({
        role: msg.sender === 'user' ? 'user' : 'model',
        parts: [{ text: msg.text }]
    }));
    contents.push({ role: 'user', parts: [{ text: currentMessage }] });

    try {
        const response = await ai.models.generateContent({
            model: chatModel,
            contents: contents,
            config: {
                systemInstruction: "You are the Destiny AI, a friendly and professional assistant embedded in a numerology website. Answer any question, but keep your responses engaging and professional. You MUST use Markdown for all formatting."
            }
        });

        res.json({ text: response.text });
        
    } catch (error) {
        console.error("Gemini Chat Error:", error);
        res.status(500).send({ error: "Failed to communicate with the chatbot." });
    }
});


// --- Start Server ---
app.listen(PORT, () => {
    console.log(`Server running at http://localhost:${PORT}`);
});

--- END FILE: server.js ---

--- START FILE: vercel.json ---

{
  "version": 2,
  "builds": [
    {
      "src": "server.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "server.js"
    }
  ]
}

--- END FILE: vercel.json ---

--- START FILE: public\index.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Destiny Matrix | Advanced Numerology Profile</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Google Fonts for Premium Theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons (Input Enhancements & Vault) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Load marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- STEP 7.1: Load pdfmake for professional PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.js"></script>
    
    <!-- STEP 1.1: Load Flatpickr CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
    
    <!-- STEP 5.1: Cosmic Canvas Background -->
    <canvas id="cosmos"></canvas>
    
    <!-- ðŸ—‚ï¸ Destiny Vault Trigger -->
    <button id="vault-trigger" onclick="toggleVault()">
        <i class="fas fa-box-open"></i> My Destiny Vault
    </button>
    
    <header>
        <h1>The Destiny Matrix</h1>
        <p>Decode the hidden patterns of your life. Advanced Life Path Analysis powered by Small AI v2.</p>
        <p class="credibility-line">Based on Chaldean Numerology, enhanced with AI & Vedic planetary wisdom.</p>
    </header>

    <main>
        <!-- 1. Comprehensive Profile Section -->
        <section id="numerology-app" class="card">
            <h2>Your Personal Destiny Profile</h2>
            <p class="description">Calculate your Birth Number (Personality), Life Path (Mission), Archetype, and Best Fit Career Vocation.</p>
            
            <div class="input-container">
                <div class="input-group">
                    <label for="full-name">Full Name (at birth):</label>
                    <div class="input-field-wrapper">
                        <i class="input-icon fas fa-user-tag"></i>
                        <input type="text" id="full-name" placeholder="John Michael Doe">
                    </div>
                    <p class="helper-text">Use the name exactly as shown on your birth certificate.</p>
                </div>
                <div class="input-group">
                    <label for="dob">Date of Birth:</label>
                    <div class="input-field-wrapper">
                        <i class="input-icon fas fa-calendar-alt"></i>
                        <!-- STEP 1.2: Updated DOB input for Flatpickr -->
                        <input id="dob" placeholder="Select Date of Birth" autocomplete="off">
                    </div>
                    <p class="helper-text">Your exact date determines your Life Path number.</p>
                </div>
            </div>
            
            <button id="calc-button" onclick="calculateNumerologyProfile()">Reveal My Numbers âœ¨</button>
            <p id="calc-status" class="status-message"></p>
            
            <!-- Output Wrapper starts hidden -->
            <div id="numerology-output-wrapper" class="hidden">
                <div class="export-controls">
                    <!-- Updated export button to call the new PDF function -->
                    <button class="export-button" id="export-pdf-btn" onclick="exportNumerologyReport()">Export as PDF</button>
                    <button class="export-button secondary-button" onclick="copyReportText('numerology')">Copy Text</button>
                </div>
                <div id="numerology-output" class="markdown-container">
                    <!-- Results will appear here -->
                </div>
            </div>
        </section>

        <!-- 2. Word/Number Analysis Section -->
        <section id="word-analysis-app" class="card">
            <h2>Word & Name Vibration Analyzer</h2>
            <p class="description">Input any word, name, or number (e.g., 'Company Name,' 'Address') to discover its core vibrational profile.</p>

            <div class="input-group full-width">
                <label for="input-word">Name or Number to Analyze:</label>
                <div class="input-field-wrapper">
                    <i class="input-icon fas fa-magic"></i>
                    <input type="text" id="input-word" placeholder="Project Phoenix, Apple Inc, My Street Address">
                </div>
                <p class="helper-text">Analyze anything from business names to important dates or concepts.</p>
            </div>

            <button onclick="analyzeWordProfile()">Analyze Vibration âš¡</button>
            <p id="word-status" class="status-message"></p>
            
            <!-- Output Wrapper starts hidden -->
            <div id="word-output-wrapper" class="hidden">
                <div class="export-controls">
                    <!-- NOTE: Legacy export remains but will show an alert since html2pdf was removed -->
                    <button class="export-button" onclick="exportReport('word')">Export as PDF</button>
                    <button class="export-button secondary-button" onclick="copyReportText('word')">Copy Text</button>
                </div>
                <div id="word-output" class="markdown-container">
                    <!-- Results will appear here -->
                </div>
            </div>
        </section>
    </main>

    <!-- ðŸ—‚ï¸ Destiny Vault Side Panel -->
    <div id="destiny-vault" class="closed">
        <div class="vault-header">
            <h3><i class="fas fa-scroll"></i> My Destiny Vault</h3>
            <button id="vault-close" onclick="toggleVault()"><i class="fas fa-times"></i></button>
        </div>
        <div id="vault-list">
            <p style="text-align: center; color: #999;">Loading saved profiles...</p>
        </div>
        <div id="vault-footer">
            Profiles are stored securely on this device's local storage.
            <button class="export-button delete-btn" style="width:100%; margin-top: 10px;" onclick="clearVault()">Clear All Profiles</button>
        </div>
    </div>


    <!-- Floating AI Chatbot Container -->
    <div id="chatbot-container">
        <div id="chat-header" onclick="toggleChat()">
            ðŸ¤– Destiny AI Chat ðŸ’¬
        </div>
        <div id="chat-window" class="closed">
            <div id="chat-messages">
                <!-- Messages populate here -->
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ask about numerology or life purpose..." onkeydown="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let chatHistory = [];
        const VAULT_KEY = 'destinyVaultProfiles';

        // --- STEP 5.2: Cosmic Animation Script ---
        const canvas = document.getElementById("cosmos");
        const ctx = canvas.getContext("2d");

        // Set initial size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Resize handler
        window.addEventListener('resize', () => {
             canvas.width = window.innerWidth;
             canvas.height = window.innerHeight;
        });

        const stars = Array.from({ length: 150 }, () => ({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 1.5,
          vx: (Math.random() - 0.5) * 0.005, 
          vy: 0.05 + Math.random() * 0.1
        }));

        function animateCosmos() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
          stars.forEach(s => {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
            
            s.x += s.vx;
            s.y += s.vy;
            
            if (s.y > canvas.height) s.y = 0;
            if (s.x > canvas.width) s.x = 0;
            if (s.x < 0) s.x = canvas.width;
          });
          requestAnimationFrame(animateCosmos);
        }
        
        // --- Flatpickr Initialization (STEP 1.3) ---
        flatpickr("#dob", {
            dateFormat: "Y-m-d", 
            maxDate: "today",
            yearSelectorType: "dropdown",
        });
        
        // --- Utility Functions ---

        // NEW UTILITY: Function to convert markdown string content to plain text runs
        // This function handles simple markdown elements (bolding, lists) 
        // using pdfmake's 'text' array structure, ensuring dark, readable text.
        function formatReportContent(markdownText, baseColor = '#222222') {
            if (!markdownText) return [{ text: 'Content data is missing.', color: '#888', margin: [0, 5, 0, 0] }];

            // CRITICAL FIX: Clean up residual HTML list tags inserted by the AI
            // 1. Replace <li> with a list marker (* ) and remove closing </li>
            // Use \s* to handle potential whitespace inside tags, and /gi for case-insensitive global replacement.
            let cleanedText = markdownText.replace(/<\s*li\s*>/gi, '* ').replace(/<\/\s*li\s*>/gi, '');
            // 2. Remove <ul> and <ol> tags entirely, including attributes (like <ul style="...">)
            cleanedText = cleanedText.replace(/<\s*ul[^>]*>/gi, '').replace(/<\/\s*ul\s*>/gi, '');
            cleanedText = cleanedText.replace(/<\s*ol[^>]*>/gi, '').replace(/<\/\s*ol\s*>/gi, '');
            
            // Re-apply original text to start parsing
            const elements = [];
            // Use cleanedText here
            const lines = cleanedText.split('\n'); 
            let currentList = null;
            let listType = null;
            let listMargin = [0, 2, 0, 0];
            
            // Function to process a single line for inline bolding
            const processLine = (line) => {
                const textRuns = [];
                // Split by bold markers (**)
                const parts = line.split(/(\*\*.*?\*\*)/g).filter(p => p.length > 0); 

                parts.forEach(part => {
                    if (part.startsWith('**') && part.endsWith('**')) {
                        // Bold text for keywords
                        textRuns.push({ text: part.substring(2, part.length - 2), bold: true, color: '#333333' });
                    } else {
                        // Standard body text
                        textRuns.push({ text: part, color: baseColor });
                    }
                });
                return textRuns;
            };

            for (let line of lines) {
                line = line.trim();
                if (!line) {
                    currentList = null; // Break list context on empty line
                    listType = null;
                    continue;
                }
                
                // Handle Lists (* or - or 1.)
                if (line.startsWith('* ') || line.startsWith('- ')) {
                    if (!currentList || listType !== 'ul') {
                        currentList = { ul: [], margin: [0, 5, 0, 5], lineHeight: 1.4 };
                        elements.push(currentList);
                        listType = 'ul';
                    }
                    // Extract content after the list marker
                    const content = line.startsWith('* ') ? line.substring(2).trim() : line.substring(2).trim();
                    currentList.ul.push({ text: processLine(content), margin: listMargin });
                } else if (line.match(/^\d+\. /)) {
                    if (!currentList || listType !== 'ol') {
                        currentList = { ol: [], margin: [0, 5, 0, 5], lineHeight: 1.4 };
                        elements.push(currentList);
                        listType = 'ol';
                    }
                    currentList.ol.push({ text: processLine(line.substring(line.indexOf('.') + 1).trim()), margin: listMargin });
                } else {
                    currentList = null;
                    listType = null;
                    
                    // Plain paragraph (use the text array structure for formatting consistency)
                    elements.push({ text: processLine(line), margin: [0, 5, 0, 0], lineHeight: 1.4 });
                }
            }
            return elements;
        }

        // Function to safely sanitize and render Markdown (handles structured input)
        const renderStructuredReport = (structuredData) => {
            if (!structuredData) return '';
            
            // Manually build the report structure using markdown strings from the JSON
            let markdown = '';
            
            // CRITICAL FIX: Use nullish coalescing (?? '') to prevent "undefined" injection
            markdown += `# ${structuredData.title ?? 'Untitled Destiny Profile'}\n\n`;
            
            markdown += `## 1. Core Life Path Summary (Chaldean Numerology)\n`;
            markdown += structuredData.lifePathSummary ?? 'Content not generated. Please try again.';
            
            markdown += `\n## 2. Vedic Planetary Fusion (Graha Drishti)\n`;
            markdown += structuredData.vedicFusion ?? 'Content not generated. Please try again.';

            markdown += `\n## 3. Destiny Number (Name Expression)\n`;
            markdown += structuredData.destinyExplanation ?? 'Content not generated. Please try again.';
            
            markdown += `\n## 4. Strengths, Challenges & Remedial Actions\n`;
            
            markdown += `\n### ðŸ’¡ Key Strengths\n`;
            markdown += structuredData.strengths ?? '* Strengths section failed to load.';

            markdown += `\n### ðŸš§ Potential Challenges\n`;
            markdown += structuredData.challenges ?? '* Challenges section failed to load.';
            
            markdown += `\n### ðŸ•‰ï¸ Remedial Suggestions (Upayes)\n`;
            markdown += structuredData.remedies ?? '* Remedial suggestions failed to load.';
            
            // Render the final Markdown string to HTML
            return marked.parse(markdown);
        };
        
        const generateId = () => Math.random().toString(36).substring(2, 9);
        
        // --- Destiny Vault (Local Storage) Logic - Updated for JSON Structure ---
        
        function loadVault() {
            try {
                const profiles = JSON.parse(localStorage.getItem(VAULT_KEY) || '[]');
                return profiles.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } catch (e) {
                console.error("Error loading vault. Clearing corrupt storage.", e);
                localStorage.removeItem(VAULT_KEY); 
                return [];
            }
        }

        // STEP 4.1: Modified save function to handle structured reports
        function saveProfileToVault(profileData) {
            const profiles = loadVault();
            const newProfile = { 
                ...profileData, 
                id: generateId(), 
                createdAt: new Date().toISOString()
            };
            
            if (!newProfile.result || !newProfile.result.title) {
                console.error("Attempted to save corrupted or incomplete structured profile data.");
                return;
            }
            
            profiles.unshift(newProfile);
            localStorage.setItem(VAULT_KEY, JSON.stringify(profiles.slice(0, 20)));
            renderVault();
        }

        function renderVault() {
            const profiles = loadVault();
            const listDiv = document.getElementById('vault-list');
            listDiv.innerHTML = ''; 
            
            let renderedCount = 0;
            const validProfiles = [];
            let corruptionDetected = false;

            profiles.forEach(profile => {
                if (!profile.metadata || !profile.metadata.name || !profile.result || typeof profile.result !== 'object' || !profile.result.title) {
                    corruptionDetected = true;
                    return; 
                }
                
                validProfiles.push(profile);
                
                const date = new Date(profile.createdAt).toLocaleDateString();
                const card = document.createElement('div');
                card.classList.add('vault-profile-card');
                
                const reportTitle = profile.result.title || "Untitled Report";
                
                card.innerHTML = `
                    <h4>${reportTitle}</h4>
                    <p>DOB: ${profile.metadata.dob} | Life Path: ${profile.metadata.lifePathNo}</p>
                    <p class="small-meta">Saved: ${date}</p>
                    <div class="vault-actions">
                        <button class="load-btn" onclick="loadProfileFromVault('${profile.id}')"><i class="fas fa-redo"></i> Load Report</button>
                        <button class="delete-btn" onclick="deleteProfileFromVault('${profile.id}')"><i class="fas fa-trash-alt"></i> Delete</button>
                    </div>
                `;
                listDiv.appendChild(card);
                renderedCount++;
            });
            
            if (corruptionDetected) {
                localStorage.setItem(VAULT_KEY, JSON.stringify(validProfiles));
            }

            if (renderedCount === 0) {
                 listDiv.innerHTML = '<p class="vault-empty-message">Your Destiny Vault is empty. Generate a profile to save it!</p>';
            }
        }
        
        function loadProfileFromVault(id) {
            const profiles = loadVault();
            const profile = profiles.find(p => p.id === id);

            if (profile) {
                document.getElementById('full-name').value = profile.metadata.name;
                document.getElementById('dob').value = profile.metadata.dob; 
                
                const outputWrapper = document.getElementById('numerology-output-wrapper');
                const outputDiv = document.getElementById('numerology-output');
                const statusDiv = document.getElementById('calc-status');
                
                outputDiv.innerHTML = renderStructuredReport(profile.result);
                outputWrapper.classList.remove('hidden');
                
                statusDiv.textContent = `Profile for ${profile.metadata.name} loaded from Vault.`;
                statusDiv.style.color = 'var(--secondary-color)';
                
                toggleVault(false);
                document.getElementById('numerology-output-wrapper').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } else {
                alert("Profile not found. It may have been cleared or corrupted.");
                renderVault(); 
            }
        }
        
        function deleteProfileFromVault(id) {
            if (confirm("Are you sure you want to permanently delete this profile?")) {
                let profiles = loadVault();
                profiles = profiles.filter(p => p.id !== id);
                localStorage.setItem(VAULT_KEY, JSON.stringify(profiles));
                renderVault();
            }
        }

        function clearVault() {
            if (confirm("Are you sure you want to delete ALL profiles from your Destiny Vault? This cannot be undone.")) {
                localStorage.removeItem(VAULT_KEY); 
                renderVault();
                alert("Destiny Vault cleared.");
            }
        }
        
        function toggleVault(shouldOpen) {
            const vault = document.getElementById('destiny-vault');
            const body = document.body;
            
            const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !vault.classList.contains('open');

            if (isOpen) {
                vault.classList.add('open');
                body.classList.add('vault-open');
                renderVault();
            } else {
                vault.classList.remove('open');
                body.classList.remove('vault-open');
            }
        }

        // Initialize vault rendering and cosmos animation
        document.addEventListener('DOMContentLoaded', () => {
             renderVault();
             animateCosmos(); // Start the animation
             if (chatHistory.length === 0) {
                 chatHistory.push({ sender: 'model', text: "Welcome! I am the Destiny AI, powered by Small AI v2. Ask me about numerology, spiritual topics, or any general inquiry." });
             }
        });
        
        
        // --- Core Calculation Logic (Updated for Structured Response) ---
        async function calculateNumerologyProfile() {
            const name = document.getElementById('full-name').value;
            const dob = document.getElementById('dob').value; 
            const outputWrapper = document.getElementById('numerology-output-wrapper');
            const outputDiv = document.getElementById('numerology-output');
            const statusDiv = document.getElementById('calc-status');
            const calcButton = document.getElementById('calc-button');
            
            outputWrapper.classList.add('hidden');

            if (!name || !dob) {
                statusDiv.textContent = "Please ensure both name and date of birth are entered.";
                statusDiv.style.color = 'var(--accent-gold)'; 
                return;
            }

            statusDiv.textContent = "Analyzing your Destiny Matrix...";
            statusDiv.style.color = 'var(--secondary-color)';
            outputDiv.innerHTML = '<p class="loading-animation">Calculating core vibration and planetary influences...</p>';
            calcButton.classList.add('button-loading');
            calcButton.innerHTML = '<span>Calculating Destiny...</span>';
            calcButton.disabled = true;

            try {
                const response = await fetch('/api/numerology-profile', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, dob })
                });

                const data = await response.json();

                if (!response.ok) {
                    // FIX 1: Ensure we catch non-200 responses (like the 500 sent by server.js on API failure)
                    const errorMessage = data.error || `Server responded with status ${response.status}.`;
                    statusDiv.textContent = `Critical Error: ${errorMessage}`;
                    statusDiv.style.color = 'var(--accent-gold)'; 
                    outputDiv.innerHTML = `<p style="color: var(--accent-gold);">Error during processing. This is often due to an overloaded AI model (Code 503) or a misconfigured API key.</p>`;
                    return;
                }
                
                // FIX 2: Check for essential content validity (i.e., did the AI actually return the expected structured data?)
                if (!data.result || typeof data.result !== 'object' || !data.result.title) {
                    statusDiv.textContent = "Error: AI generation failed to return a structured profile. Try again.";
                    statusDiv.style.color = 'var(--accent-gold)'; 
                    outputDiv.innerHTML = `<p style="color: var(--accent-gold);">The AI failed to generate the structured report, possibly due to a temporary service issue. Please wait a moment and try recalculating.</p>`;
                    return;
                }
                
                // SUCCESS PATH
                statusDiv.textContent = "Profile Generated Successfully. Report saved to your Destiny Vault.";
                statusDiv.style.color = 'var(--secondary-color)';
                
                // Use the new structured renderer
                outputDiv.innerHTML = renderStructuredReport(data.result);
                outputWrapper.classList.remove('hidden'); 
                
                // CRITICAL: Save the generated profile to the Destiny Vault immediately
                saveProfileToVault(data);


            } catch (error) {
                statusDiv.textContent = "A network error occurred or the AI failed to return structured data.";
                statusDiv.style.color = 'var(--accent-gold)';
                outputDiv.innerHTML = `<p style="color: var(--accent-gold);">Network/Parsing Error: ${error.message}</p>`;
                console.error('Calculation Error:', error);
            } finally {
                // End Loading State UI
                calcButton.classList.remove('button-loading');
                calcButton.innerHTML = 'Reveal My Numbers âœ¨';
                calcButton.disabled = false;
            }
        }
        
        // --- Word Analysis (Remains the same, returns raw markdown) ---
        async function analyzeWordProfile() {
            const input = document.getElementById('input-word').value;
            const outputWrapper = document.getElementById('word-output-wrapper');
            const outputDiv = document.getElementById('word-output');
            const statusDiv = document.getElementById('word-status');
            const analyzeButton = document.querySelector('#word-analysis-app button');


            outputWrapper.classList.add('hidden');

            if (!input) {
                statusDiv.textContent = "Please enter a word, name, or number to analyze.";
                statusDiv.style.color = 'var(--accent-gold)';
                return;
            }

            statusDiv.textContent = "Analyzing vibrational frequency...";
            statusDiv.style.color = 'var(--secondary-color)';
            outputDiv.innerHTML = '<p class="loading-animation">Calculating core vibration...</p>';
            
            analyzeButton.classList.add('button-loading');
            analyzeButton.innerHTML = '<span>Calculating Vibration...</span>';
            analyzeButton.disabled = true;


            try {
                const response = await fetch('/api/word-profile', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input })
                });

                const data = await response.json();

                if (data.error || !response.ok) {
                    statusDiv.textContent = `Error: Analysis failed. Please try again.`;
                    statusDiv.style.color = 'var(--accent-gold)';
                    outputDiv.innerHTML = `<p style="color: var(--accent-gold);">Analysis failed.</p>`;
                    return; 
                }

                statusDiv.textContent = "Vibration Analysis Complete.";
                statusDiv.style.color = 'var(--secondary-color)';
                outputDiv.innerHTML = marked.parse(data.result); 
                outputWrapper.classList.remove('hidden');

            } catch (error) {
                statusDiv.textContent = "A network error occurred. Check your connection.";
                statusDiv.style.color = 'var(--accent-gold)';
                outputDiv.innerHTML = `<p style="color: var(--accent-gold);">Network Error.</p>`;
                console.error('Word Analysis Error:', error);
            } finally {
                analyzeButton.classList.remove('button-loading');
                analyzeButton.innerHTML = 'Analyze Vibration âš¡';
                analyzeButton.disabled = false;
            }
        }

        // --- Export Functions (REWRITTEN: Professional PDFMake - GOAL 1) ---
        
        // Removed markdownToPdfMake utility function
        
        function exportNumerologyReport() {
            const profiles = loadVault();
            const reportData = profiles[0]; 

            if (!reportData || !reportData.result || typeof reportData.result !== 'object') {
                alert("Please generate a Destiny Profile first, and ensure the Destiny Vault is not empty.");
                return;
            }

            const meta = reportData.metadata;
            const data = reportData.result;
            
            // --- PROFESSIONAL PDF STYLES ---
            const styles = {
                header: { 
                    fontSize: 24, 
                    bold: true, 
                    color: '#2c3e50', // Dark Blue/Black for print
                    alignment: 'center', 
                    margin: [0, 0, 0, 10] 
                },
                title: { 
                    fontSize: 32, 
                    bold: true, 
                    color: '#8e44ad', // Deep Purple
                    alignment: 'center', 
                    margin: [0, 20, 0, 30] 
                },
                sectionHeader: { 
                    fontSize: 18, 
                    bold: true, 
                    color: '#34495e', // Dark Gray-Blue
                    margin: [0, 30, 0, 10], 
                    decoration: 'underline', 
                    decorationColor: '#bdc3c7',
                    pageBreak: 'before' // Explicit page break for major sections
                },
                subHeader: { 
                    fontSize: 14, 
                    bold: true, 
                    color: '#34495e', 
                    margin: [0, 15, 0, 5] 
                },
                body: { 
                    fontSize: 11, 
                    color: '#222222', // Near-black for print readability
                    lineHeight: 1.5, 
                    margin: [0, 2, 0, 0] 
                },
                tableHeader: {
                    fontSize: 12, 
                    bold: true, 
                    color: '#222222', 
                    fillColor: '#ecf0f1', // Light Gray background for header row
                    alignment: 'center'
                },
                meta: { 
                    fontSize: 10, 
                    color: '#7f8c8d', 
                    alignment: 'right', 
                    margin: [0, 0, 0, 4] 
                }
            };

            // --- PROFESSIONAL PDF CONTENT STRUCTURE ---
            const docDefinition = {
                pageSize: 'A4',
                // Explicitly set page margins (A4 standard margin)
                pageMargins: [60, 60, 60, 60], 
                
                // White background is standard for printing (Dark background removed)
                background: () => ({
                    canvas: [{
                        type: 'rect',
                        x: 0, y: 0, w: 595, h: 842,
                        color: '#FFFFFF' // Ensure white background
                    }]
                }),
                
                header: (currentPage, pageCount) => ({
                    text: `Destiny Profile Report | Page ${currentPage} of ${pageCount}`,
                    style: 'meta',
                    margin: [60, 20, 60, 0]
                }),

                content: [
                    // --- Page 1: Title and Metadata ---
                    { text: 'The Destiny Matrix', style: 'header' },
                    { text: data.title, style: 'title' },

                    // User Details Table (GOAL: Fix Tables)
                    {
                        text: 'Core Numerological Coordinates',
                        style: 'subHeader',
                        margin: [0, 5, 0, 5]
                    },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', '*', '*', '*', '*'],
                            body: [
                                [
                                    { text: 'Name', style: 'tableHeader' }, 
                                    { text: 'DOB', style: 'tableHeader' }, 
                                    { text: 'Life Path', style: 'tableHeader' }, 
                                    { text: 'Birth No.', style: 'tableHeader' }, 
                                    { text: 'Destiny No.', style: 'tableHeader' }
                                ],
                                [
                                    { text: meta.name, style: 'body', alignment: 'center' }, 
                                    { text: meta.dob, style: 'body', alignment: 'center' }, 
                                    { text: `${meta.lifePathNo} (${meta.missionPlanet})`, style: 'body', alignment: 'center' }, 
                                    { text: `${meta.birthNo} (${meta.birthPlanet})`, style: 'body', alignment: 'center' }, 
                                    { text: `${meta.destinyNo} (${meta.destinyPlanet})`, style: 'body', alignment: 'center' }
                                ]
                            ]
                        },
                        layout: {
                            // Simple, print-safe horizontal lines
                            hLineWidth: (i, node) => (i === 0 || i === 1 || i === node.table.body.length) ? 1 : 0.5,
                            vLineWidth: () => 0,
                            hLineColor: () => '#95a5a6',
                            fillColor: (i) => (i === 0) ? '#ecf0f1' : null,
                            paddingLeft: () => 5, paddingRight: () => 5, paddingTop: () => 8, paddingBottom: () => 8
                        },
                        margin: [0, 10, 0, 30] // Increased spacing after the table
                    },

                    // Section 1: Core Life Path (GOAL: Content Flow)
                    { text: '1. Core Life Path Summary (Chaldean Numerology)', style: 'sectionHeader', pageBreak: 'before' }, 
                    ...formatReportContent(data.lifePathSummary),

                    // Section 2: Vedic Fusion
                    { text: `2. Vedic Planetary Fusion (Graha Drishti)`, style: 'sectionHeader' },
                    ...formatReportContent(data.vedicFusion),
                    
                    // Section 3: Destiny Number
                    { text: `3. Destiny Number & Ultimate Expression`, style: 'sectionHeader' },
                    ...formatReportContent(data.destinyExplanation),

                    // Section 4: Key Traits
                    { text: '4. Key Strengths & Challenges', style: 'sectionHeader' },
                    
                    { text: 'Key Strengths:', style: 'subHeader' },
                    ...formatReportContent(data.strengths),

                    { text: 'Potential Challenges:', style: 'subHeader' },
                    ...formatReportContent(data.challenges),

                    // Section 5: Remedies
                    { text: '5. Remedial Suggestions (Upayes)', style: 'sectionHeader' },
                    ...formatReportContent(data.remedies),
                    
                    // Footer Info
                    { 
                        text: `\nReport Generated: ${new Date().toLocaleDateString()}`, 
                        style: 'meta',
                        margin: [0, 30, 0, 0] // Ensure margin for clean look
                    }
                ],
                styles: styles
            };

            // Download the PDF
            pdfMake.createPdf(docDefinition).download(`${meta.name.replace(/\s/g, '_')}_Destiny_Report.pdf`);
        }
        
        // This function intercepts the word analysis export which relied on html2pdf
        function exportReport(type) {
             if (type === 'numerology') {
                 exportNumerologyReport();
             } else {
                 alert("The Word Analysis PDF export is temporarily disabled. Please use the Destiny Profile PDF function.");
             }
        }
        
        // --- Copy Report Text (Adapted for Structured Data) ---

        function getReportData(type) {
            if (type === 'numerology') {
                const profiles = loadVault();
                if (profiles.length === 0) return null;
                // Rely on the innerText of the rendered markdown output
                return {
                    element: document.getElementById('numerology-output'), 
                    name: profiles[0].metadata.name,
                };
            } else if (type === 'word') {
                return {
                    element: document.getElementById('word-output'),
                    name: document.getElementById('input-word').value || 'Vibration',
                };
            }
            return null;
        }

        async function copyReportText(type) {
            const report = getReportData(type);
            if (!report || !report.element.innerText.trim()) {
                alert("Please generate a profile first before attempting to copy.");
                return;
            }

            const textContent = report.element.innerText;

            try {
                await navigator.clipboard.writeText(textContent);
                const statusDivId = type === 'numerology' ? 'calc-status' : 'word-status';
                const statusDiv = document.getElementById(statusDivId);
                
                const originalText = statusDiv.textContent;
                const originalColor = statusDiv.style.color;
                
                statusDiv.textContent = `Report text copied successfully!`;
                statusDiv.style.color = 'var(--secondary-color)';
                
                setTimeout(() => {
                    statusDiv.textContent = originalText;
                    statusDiv.style.color = originalColor;
                }, 3000);
                
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy text. Please try selecting the text manually.');
            }
        }

        // --- Chatbot Logic (Unchanged) ---
        function toggleChat() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.classList.toggle('closed');
        }
        
        function addMessageToChat(text, sender) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);
            messageElement.innerHTML = marked.parse(text); 
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendChatMessage() {
            const inputField = document.getElementById('chat-input');
            const messageText = inputField.value.trim();

            if (!messageText) return;

            addMessageToChat(messageText, 'user');
            chatHistory.push({ sender: 'user', text: messageText });
            inputField.value = '';

            const messagesDiv = document.getElementById('chat-messages');
            const loadingElement = document.createElement('div');
            loadingElement.classList.add('chat-message', 'model', 'loading');
            loadingElement.innerHTML = '...';
            messagesDiv.appendChild(loadingElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        currentMessage: messageText, 
                        history: chatHistory.slice(0, -1) 
                    })
                });

                const data = await response.json();
                
                messagesDiv.removeChild(loadingElement);

                if (data.error) {
                    addMessageToChat(`[Error] Failed to get response.`, 'model');
                    return;
                }

                addMessageToChat(data.text, 'model');
                chatHistory.push({ sender: 'model', text: data.text });

            } catch (error) {
                console.error('Chat API Error:', error);
                if (loadingElement.parentNode) messagesDiv.removeChild(loadingElement);
                addMessageToChat("Sorry, I hit a server error.", 'model');
            }
        }
    </script>
</body>
</html>


--- END FILE: public\index.html ---

--- START FILE: public\style.css ---

/* public/style.css - Advanced Dark Theme: Ancient Wisdom x Modern Intelligence */

:root {
    /* Theme Colors */
    --primary-color: #3A1C71; /* Royal Purple */
    --secondary-color: #6EE7E7; /* Soft Cyan/AI Accent */
    --accent-gold: #F4C430; /* Gold/Amber */
    
    /* Background & Text */
    --background-dark: #0B1026; /* Midnight Blue */
    --card-background-semi: rgba(26, 31, 60, 0.6); /* Semi-transparent card base */
    --text-light: #E0E0E0; 
    --text-dark: #FFFFFF;
    
    /* Borders & Shadows */
    --border-color: rgba(65, 55, 100, 0.4);
    --shadow-deep: 0 10px 30px rgba(0, 0, 0, 0.4);
}

/* Global Font Definition */
body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--background-dark); 
    color: var(--text-light);
    line-height: 1.7;
    min-height: 100vh;
    overflow-x: hidden; 
}

/* --- STEP 5.3: Cosmic Canvas Background --- */
#cosmos {
    position: fixed;
    inset: 0;
    z-index: -2; 
    pointer-events: none;
    background: linear-gradient(135deg, var(--background-dark) 0%, #1A1F3C 100%);
}

/* --- VAULT OPEN STATE MANAGEMENT --- */
body.vault-open main,
body.vault-open header {
    filter: blur(2px) grayscale(30%);
    pointer-events: none;
    user-select: none;
    transition: filter 0.3s ease;
}

body.vault-open #vault-trigger {
    opacity: 0;
    pointer-events: none;
}
body.vault-open #chatbot-container {
     filter: blur(1px) brightness(0.8);
}


/* --- Header Polish --- */
header {
    background: rgba(11, 16, 38, 0.8); 
    padding: 40px 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden; 
    z-index: 1;
}

/* Subtle background glow/texture for Hero Section */
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 10%, rgba(244, 196, 48, 0.05) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
}

header h1 {
    z-index: 1;
    position: relative;
    margin: 0;
    font-size: clamp(2.5em, 5vw, 3.5em);
    font-weight: 700;
    color: var(--accent-gold);
    font-family: 'Cormorant Garamond', serif;
}
header p {
    z-index: 1;
    position: relative;
    margin-top: 5px;
    opacity: 0.7;
    font-size: 1.1em;
}

/* New Credibility Line Style */
.credibility-line {
    margin-top: 15px;
    font-size: 0.9em;
    color: var(--secondary-color);
    font-weight: 500;
    letter-spacing: 0.5px;
}

main {
    max-width: 1000px; 
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    gap: 30px;
    position: relative;
    z-index: 1;
}

/* --- Card Styles --- */
.card {
    background: var(--card-background-semi); 
    backdrop-filter: blur(8px); 
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid var(--border-color);
    padding: 30px;
    border-radius: 16px;
    box-shadow: var(--shadow-deep);
}

.card h2 {
    color: var(--secondary-color);
    border-bottom: 2px solid rgba(110, 231, 231, 0.2);
    padding-bottom: 15px;
    margin-top: 0;
    font-size: 2em;
    font-family: 'Cormorant Garamond', serif;
}

/* --- Input Fields with Icons and Helper Text --- */
.input-container {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}
.input-group {
    flex: 1;
    padding-top: 5px; 
    position: relative;
}
.input-field-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}
.input-icon {
    position: absolute;
    left: 12px;
    color: #888;
    pointer-events: none;
    font-size: 1.1em;
}
.helper-text {
    font-size: 0.75em;
    color: #999;
    margin-top: 4px;
    padding-left: 5px;
}

/* Targeting Flatpickr input and normal text input */
input[type="text"], 
.flatpickr-input { 
    width: 100%;
    padding: 14px 14px 14px 40px; 
    background-color: rgba(0, 0, 0, 0.3); 
    color: var(--text-dark);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-sizing: border-box;
    font-size: 1em;
    height: 48px;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input[type="text"]:focus, 
.flatpickr-input:focus {
    border-color: var(--accent-gold);
    outline: none;
    box-shadow: 0 0 10px rgba(244, 196, 48, 0.5); /* Gold glow on focus */
}
.input-group.full-width input {
    padding-left: 40px;
}
.input-group.full-width .input-icon {
    left: 12px;
}

/* Flatpickr Dark Theme adjustments */
.flatpickr-calendar {
    background: #1A1F3C !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-deep) !important;
}
.flatpickr-day {
    color: var(--text-light) !important;
}
.flatpickr-day.selected, .flatpickr-day.selected:hover {
    background: var(--secondary-color) !important;
    border-color: var(--secondary-color) !important;
    color: var(--background-dark) !important;
}
.flatpickr-day.today {
    border-color: var(--accent-gold) !important;
}
.flatpickr-day.today:hover {
    background: var(--accent-gold) !important;
    color: var(--background-dark) !important;
}
.flatpickr-months .flatpickr-month {
    color: var(--secondary-color) !important;
}
.flatpickr-current-month .flatpickr-monthDropDown-months, 
.numInputWrapper {
    color: var(--text-light) !important;
    background: transparent !important;
}


/* --- CTA Button & Loading State --- */
button {
    background-color: var(--accent-gold);
    color: var(--background-dark); 
    padding: 14px 30px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 15px;
    font-size: 1.1em;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden; 
}

/* Glow Pulse effect */
button:not(.export-button):hover {
    background-color: #fce89f;
    box-shadow: 0 0 15px rgba(244, 196, 48, 0.7), 0 0 5px rgba(244, 196, 48, 1) inset;
}

/* STEP 3.2: Floating Animation for the Vault Trigger */
@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0); }
}

#vault-trigger {
    animation: float 3s ease-in-out infinite;
    position: fixed;
    top: 25px;
    right: 25px;
    padding: 12px 20px;
    background-color: var(--primary-color);
    color: var(--text-dark);
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-deep);
    z-index: 1010;
    transition: background-color 0.2s;
}
#vault-trigger:hover {
    background-color: #553399;
    animation-play-state: paused; 
}


.button-loading {
    cursor: not-allowed;
    background-color: #f7d979; 
    position: relative;
    overflow: hidden;
}
.button-loading::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background-color: rgba(0, 0, 0, 0.1);
    animation: progress 5s forwards; 
    z-index: 1;
}
.button-loading span {
    position: relative;
    z-index: 2;
}

@keyframes progress {
    0% { width: 0; }
    100% { width: 100%; }
}

.status-message {
    color: var(--secondary-color) !important;
}

/* --- Export Controls --- */
.export-controls {
    margin-bottom: 15px;
    text-align: right;
}
.export-button {
    padding: 10px 18px;
    font-size: 0.9em;
    margin-left: 10px;
    margin-top: 0; 
    color: white; 
    background-color: var(--primary-color);
}
.export-button:hover {
    background-color: #553399;
    box-shadow: 0 0 8px rgba(58, 28, 113, 0.8);
}
.export-controls .secondary-button {
    background-color: #6c757d; 
}
.export-controls .secondary-button:hover {
    background-color: #5a6268;
}

/* Hide report wrappers initially */
#numerology-output-wrapper.hidden, #word-output-wrapper.hidden {
    display: none;
}

/* --- Markdown Output Enhancements --- */
.markdown-container {
    padding: 25px;
    border: 1px solid var(--border-color);
    border-left: 6px solid var(--secondary-color);
    background-color: rgba(58, 28, 113, 0.3); 
    border-radius: 12px;
    line-height: 1.7;
    margin-top: 20px;
}
.markdown-container h1, .markdown-container h2, .markdown-container h3 {
    color: var(--accent-gold); 
    border-bottom: 1px solid rgba(244, 196, 48, 0.3);
    padding-bottom: 8px;
    margin-top: 30px;
    font-family: 'Cormorant Garamond', serif;
}
.loading-animation {
    color: var(--secondary-color);
    font-style: italic;
    animation: loading-pulse 1.5s infinite;
    text-align: center;
}
@keyframes loading-pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}


/* --- Destiny Vault Side Panel Styles --- */
#destiny-vault {
    position: fixed;
    top: 0;
    right: -400px; 
    width: 350px;
    max-width: 90vw;
    height: 100%;
    background: #11152a; 
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    transition: right 0.4s ease-in-out;
    display: flex;
    flex-direction: column;
}
#destiny-vault.open {
    right: 0;
}

.vault-header {
    padding: 20px;
    background: var(--primary-color);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.vault-header h3 {
    margin: 0;
    font-family: 'Cormorant Garamond', serif;
}
#vault-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5em;
    cursor: pointer;
    padding: 5px;
}
#vault-close:hover {
    color: var(--accent-gold);
}

#vault-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

/* Scrollbar styling for dark mode */
#vault-list::-webkit-scrollbar {
    width: 8px;
}
#vault-list::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}
#vault-list::-webkit-scrollbar-track {
    background: transparent;
}

.vault-profile-card {
    background: rgba(255, 255, 255, 0.08);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid var(--secondary-color);
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.vault-profile-card h4 {
    margin: 0;
    color: var(--accent-gold);
    font-size: 1.1em;
}
.vault-profile-card p {
    margin: 0;
    font-size: 0.85em;
    color: #aaa;
}
.vault-profile-card .small-meta {
    font-size: 0.75em;
    color: #666;
}
.vault-actions {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.vault-actions button {
    flex-grow: 1;
    padding: 8px 10px;
    font-size: 0.85em;
    margin-top: 0;
}
.vault-actions .load-btn {
    background-color: var(--secondary-color);
    color: var(--background-dark);
}
.vault-actions .delete-btn {
    background-color: #8c0000; 
}
.vault-actions .delete-btn:hover {
    background-color: #b30000;
}

#vault-footer {
    padding: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
    font-size: 0.8em;
    color: #666;
}

/* Mobile adjustments for vault */
@media (max-width: 768px) {
    #destiny-vault {
        width: 100%;
        right: -100vw;
    }
    #destiny-vault.open {
        right: 0;
    }
    #vault-trigger {
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 0.9em;
    }
    /* Move chat to the left to avoid clash with vault on mobile */
    #chatbot-container {
        right: auto;
        left: 15px;
    }
}

/* --- Floating AI Chatbot Styles (STEP 3.1: Resizing) --- */
#chatbot-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px; /* Fixed width */
    max-height: 80vh;
    box-shadow: var(--shadow-deep);
    border-radius: 12px;
    overflow: hidden;
    z-index: 990;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease-in-out;
}

#chat-header {
    background-color: var(--primary-color);
    color: white;
    padding: 15px 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 2px solid var(--secondary-color);
    transition: background-color 0.2s;
}

#chat-header:hover {
    background-color: #553399;
}

#chat-window {
    display: flex;
    flex-direction: column;
    height: 420px; /* STEP 3.1: Fixed height */
    background-color: #1A1F3C; 
    transition: all 0.3s ease-in-out;
}

#chat-window.closed {
    height: 0;
    padding: 0;
    border: none;
    opacity: 0;
    pointer-events: none;
}
#chat-window:not(.closed) {
    opacity: 1;
}

#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Chat Scrollbar styling */
#chat-messages::-webkit-scrollbar {
    width: 6px;
}
#chat-messages::-webkit-scrollbar-thumb {
    background-color: rgba(110, 231, 231, 0.4);
    border-radius: 3px;
}
#chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.chat-message {
    max-width: 85%;
    padding: 10px 15px;
    border-radius: 15px;
    word-wrap: break-word;
    font-size: 0.9em;
}

/* User Messages - Gold/Dark contrast */
.chat-message.user {
    align-self: flex-end;
    background-color: var(--accent-gold);
    color: var(--background-dark);
    border-bottom-right-radius: 4px;
}

/* Model Messages - Cyan/Light contrast */
.chat-message.model {
    align-self: flex-start;
    background-color: rgba(110, 231, 231, 0.2); 
    color: var(--text-light);
    border: 1px solid rgba(110, 231, 231, 0.4);
    border-bottom-left-radius: 4px;
}

.chat-message.model h3, .chat-message.model strong {
    color: var(--secondary-color);
    margin-top: 5px;
}

.chat-message.loading {
    background: rgba(255, 255, 255, 0.1);
    color: #999;
    font-style: italic;
    animation: pulse 1.5s infinite;
    align-self: flex-start;
}
@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

#chat-input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    background-color: #1A1F3C;
}

#chat-input-area input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #333;
    border-radius: 8px;
    margin-right: 8px;
    background-color: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 0.9em;
    height: 40px;
    box-sizing: border-box;
    padding-left: 12px;
}

#chat-input-area button {
    background-color: var(--secondary-color);
    color: var(--background-dark);
    padding: 0 15px;
    border-radius: 8px;
    font-size: 0.9em;
    margin-top: 0;
    height: 40px;
    width: 70px; 
}

/* Mobile adjustments for chat (Moved to left to avoid vault overlap) */
@media (max-width: 768px) {
    #chatbot-container {
        width: 90vw;
        left: 5vw;
        right: auto;
        bottom: 10px;
    }
}



--- END FILE: public\style.css ---
